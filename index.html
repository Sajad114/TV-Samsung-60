<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ - Firebase</title>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap');
*{box-sizing:border-box}

body{
    margin:0;
    font-family:'Tajawal',sans-serif;
    background:linear-gradient(135deg,#050505,#111);
    color:#fff;
}

header{
    text-align:center;
    padding:15px;
    font-size:22px;
    font-weight:700;
    background:rgba(255,255,255,.05);
    border-bottom:1px solid rgba(255,255,255,.1);
}

.container{
    max-width:900px;
    margin:auto;
    padding:15px;
}

.card{
    background:rgba(255,255,255,.06);
    border-radius:16px;
    padding:15px;
    margin-bottom:15px;
}

h2{
    margin:0 0 10px;
    font-size:16px;
    color:#00ff99;
}

input,select,button{
    width:100%;
    padding:11px;
    margin-top:6px;
    border:none;
    border-radius:10px;
    font-size:15px;
}

input,select{background:#111;color:#fff}

button{
    background:#00ff99;
    color:#000;
    font-weight:700;
    cursor:pointer;
} ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØµÙ…ÙŠÙ…  ÙˆØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø´Ø±ÙˆØ¹ Ø¨Ø³ Ù„Ø§ ØªØ®Ø±Ø¨ ÙØ§ÙŠØ±Ø¨Ø§ÙŠØ³

button.stop,button.del{background:#ff4444;color:#fff}

.controls{display:flex;gap:10px}

#scanner{
    max-width:320px;
    margin:auto;
    display:none;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}

th,td{
    padding:10px;
    border-bottom:1px solid #333;
    text-align:center;
}

th{color:#00ff99}

.search-result{
    background:#111;
    padding:10px;
    border-radius:10px;
    margin-top:6px;
}
</style>
</head>
<body>

<header>ğŸ“¦ Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Firebase)</header>

<div class="container">

<div class="card">
<h2>â• Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ</h2>
<input id="newArchive" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ">
<button id="addArchiveBtn">Ø¥Ù†Ø´Ø§Ø¡</button>
</div>

<div class="card">
<h2>ğŸ—‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h2>
<select id="archiveSelect"></select>
</div>

<div class="card">
<h2>ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>
<div class="controls">
<button id="startCam">ØªØ´ØºÙŠÙ„</button>
<button class="stop" id="stopCam">Ø¥ÙŠÙ‚Ø§Ù</button>
</div>
<div id="scanner"></div>
</div>

<div class="card">
<h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« (6 Ø£Ø±Ù‚Ø§Ù…)</h2>
<input id="searchInput" inputmode="numeric" maxlength="6" placeholder="Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„">
<div id="searchResult" class="search-result"></div>
</div>

<div class="card">
<h2>ğŸ“„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</h2>
<table>
<thead>
<tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø­Ø°Ù</th></tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

</div>

<audio id="beep" preload="auto">
<source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.mp3">
</audio>

<!-- ğŸ”¥ Firebase ES Module -->
<script type="module">
/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
import {
  getFirestore, collection, doc, getDoc, getDocs,
  setDoc, updateDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ================= FIREBASE CONFIG (Ù…Ø§Ù„ØªÙƒ) ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCGCX07TI3q2nCCPj_x7t_qZH7WJaiIOOI",
  authDomain: "fatoraqr.firebaseapp.com",
  projectId: "fatoraqr",
  storageBucket: "fatoraqr.firebasestorage.app",
  messagingSenderId: "421490248396",
  appId: "1:421490248396:web:4ac9f162587fe97fb5d069",
  measurementId: "G-QK8C1F6K4S"
};

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
getAnalytics(app);
const db = getFirestore(app);

/* ================= ELEMENTS ================= */
const select = document.getElementById("archiveSelect");
const list = document.getElementById("list");
const searchInput = document.getElementById("searchInput");
const searchResult = document.getElementById("searchResult");
const beep = document.getElementById("beep");

/* ================= LOAD ARCHIVES ================= */
async function loadArchives(){
    select.innerHTML="";
    const snap = await getDocs(collection(db,"archives"));
    snap.forEach(d=>{
        const o=document.createElement("option");
        o.value=d.id;
        o.textContent=d.id;
        select.appendChild(o);
    });
    if(select.value) loadCodes();
}

/* ================= LOAD CODES ================= */
async function loadCodes(){
    list.innerHTML="";
    const ref = doc(db,"archives",select.value);
    const snap = await getDoc(ref);
    if(!snap.exists()) return;
    snap.data().codes.forEach((c,i)=>{
        list.innerHTML+=`
        <tr>
          <td>${c}</td>
          <td><button class="del" onclick="deleteCode(${i})">Ø­Ø°Ù</button></td>
        </tr>`;
    });
}

/* ================= ADD ARCHIVE ================= */
document.getElementById("addArchiveBtn").onclick = async ()=>{
    const name=document.getElementById("newArchive").value.trim();
    if(!name) return;
    await setDoc(doc(db,"archives",name),{codes:[]});
    document.getElementById("newArchive").value="";
    loadArchives();
};

select.onchange=loadCodes;

/* ================= DELETE ================= */
window.deleteCode = async (i)=>{
    const ref = doc(db,"archives",select.value);
    const snap = await getDoc(ref);
    const arr = snap.data().codes;
    arr.splice(i,1);
    await updateDoc(ref,{codes:arr});
    loadCodes();
};

/* ================= SEARCH ================= */
searchInput.oninput = async ()=>{
    searchInput.value = searchInput.value.replace(/\D/g,"").slice(0,6);
    if(searchInput.value.length<6){
        searchResult.innerHTML="";
        return;
    }

    const snap = await getDocs(collection(db,"archives"));
    let found=[];
    snap.forEach(d=>{
        if(d.data().codes.includes(searchInput.value)){
            found.push(d.id);
        }
    });
    searchResult.innerHTML = found.length
      ? `âœ… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ: ${found.join(" , ")}`
      : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
};

/* ================= CAMERA ================= */
let qr=null,running=false,last="",time=0;

document.getElementById("startCam").onclick = async ()=>{
    if(running) return;
    qr=new Html5Qrcode("scanner");
    document.getElementById("scanner").style.display="block";
    const cams=await Html5Qrcode.getCameras();
    const cam=cams.find(c=>c.label.toLowerCase().includes("back"))||cams[0];

    await qr.start(cam.id,{fps:15,qrbox:230},async txt=>{
        const now=Date.now();
        if(txt===last && now-time<1500) return;
        last=txt; time=now;

        const ref=doc(db,"archives",select.value);
        const snap=await getDoc(ref);
        const arr=snap.data().codes;
        if(!arr.includes(txt)){
            arr.push(txt);
            await updateDoc(ref,{codes:arr});
            beep.currentTime=0;
            beep.play();
            loadCodes();
        }
    });
    running=true;
};

document.getElementById("stopCam").onclick = async ()=>{
    if(!running) return;
    await qr.stop(); qr.clear();
    document.getElementById("scanner").style.display="none";
    running=false;
};

/* ================= INIT ================= */
loadArchives();
</script>

</body>
</html>
