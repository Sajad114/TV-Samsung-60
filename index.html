<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ - Firebase</title>

<!-- QR Scanner -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;600;700;800&display=swap');

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Tajawal', sans-serif;
    background: linear-gradient(135deg, #0a1929, #1a1a2e);
    color: #fff;
    min-height: 100vh;
    line-height: 1.6;
}

/* Header */
.header {
    background: linear-gradient(90deg, #00b894, #00a085);
    padding: 1.2rem 0;
    text-align: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    position: sticky;
    top: 0;
    z-index: 100;
}

.header h1 {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 0.3rem;
}

.header p {
    font-size: 0.9rem;
    opacity: 0.9;
    font-weight: 300;
}

/* Container */
.container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 1.5rem;
}

/* Cards */
.card {
    background: rgba(255, 255, 255, 0.08);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
    border: 1px solid rgba(255, 255, 255, 0.1);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.card:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
}

.card-title {
    color: #00ff99;
    font-size: 1.2rem;
    font-weight: 700;
    margin-bottom: 1.2rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.card-title i {
    font-size: 1.3rem;
}

/* Form Elements */
.input-group {
    margin-bottom: 1rem;
}

.input-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: rgba(255, 255, 255, 0.9);
}

input, select, button {
    width: 100%;
    padding: 0.9rem 1rem;
    border: none;
    border-radius: 10px;
    font-size: 1rem;
    font-family: 'Tajawal', sans-serif;
    transition: all 0.3s ease;
}

input, select {
    background: rgba(0, 0, 0, 0.3);
    color: #fff;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

input:focus, select:focus {
    outline: none;
    border-color: #00ff99;
    box-shadow: 0 0 0 2px rgba(0, 255, 153, 0.2);
}

/* Buttons */
.btn {
    background: linear-gradient(90deg, #00ff99, #00cc7a);
    color: #000;
    font-weight: 700;
    cursor: pointer;
    border: none;
    transition: all 0.3s ease;
    padding: 1rem;
    border-radius: 10px;
    font-size: 1rem;
}

.btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(0, 255, 153, 0.3);
}

.btn:active {
    transform: translateY(0);
}

.btn-stop {
    background: linear-gradient(90deg, #ff4444, #cc0000);
    color: white;
}

.btn-del {
    background: linear-gradient(90deg, #ff6b6b, #ee5a52);
    color: white;
    padding: 0.5rem 1rem;
    font-size: 0.9rem;
}

.btn-secondary {
    background: linear-gradient(90deg, #4dabf7, #339af0);
    color: white;
}

/* Controls */
.controls {
    display: flex;
    gap: 0.8rem;
    margin-top: 1rem;
}

/* Scanner */
#scanner {
    max-width: 400px;
    margin: 1.5rem auto 0;
    border-radius: 12px;
    overflow: hidden;
    display: none;
    border: 3px solid #00ff99;
    box-shadow: 0 0 25px rgba(0, 255, 153, 0.3);
}

.scanner-info {
    text-align: center;
    margin-top: 1rem;
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
}

/* Search */
.search-container {
    position: relative;
}

#searchResult {
    background: rgba(0, 0, 0, 0.3);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
    border-right: 4px solid #00ff99;
    animation: fadeIn 0.5s ease;
}

.result-found {
    color: #00ff99;
    font-weight: 600;
}

.result-not-found {
    color: #ff6b6b;
    font-weight: 600;
}

/* Table */
.table-container {
    overflow-x: auto;
    margin-top: 1rem;
    border-radius: 10px;
    background: rgba(0, 0, 0, 0.2);
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 500px;
}

th {
    background: rgba(0, 255, 153, 0.2);
    color: #00ff99;
    font-weight: 700;
    padding: 1rem;
    text-align: center;
}

td {
    padding: 1rem;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    text-align: center;
}

tr:last-child td {
    border-bottom: none;
}

tr:hover {
    background: rgba(255, 255, 255, 0.05);
}

/* Stats */
.stats {
    display: flex;
    justify-content: space-between;
    background: rgba(255, 255, 255, 0.05);
    padding: 1rem;
    border-radius: 10px;
    margin-top: 1rem;
}

.stat-item {
    text-align: center;
}

.stat-value {
    font-size: 1.8rem;
    font-weight: 800;
    color: #00ff99;
}

.stat-label {
    font-size: 0.9rem;
    color: rgba(255, 255, 255, 0.7);
}

/* Animations */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

@keyframes pulse {
    0% { box-shadow: 0 0 0 0 rgba(0, 255, 153, 0.7); }
    70% { box-shadow: 0 0 0 10px rgba(0, 255, 153, 0); }
    100% { box-shadow: 0 0 0 0 rgba(0, 255, 153, 0); }
}

.pulse {
    animation: pulse 2s infinite;
}

/* Loading */
.loading {
    text-align: center;
    padding: 2rem;
    color: rgba(255, 255, 255, 0.7);
}

/* Footer */
.footer {
    text-align: center;
    padding: 1.5rem;
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.9rem;
    border-top: 1px solid rgba(255, 255, 255, 0.1);
    margin-top: 2rem;
}

/* Responsive */
@media (max-width: 768px) {
    .container {
        padding: 1rem;
    }
    
    .card {
        padding: 1.2rem;
    }
    
    .controls {
        flex-direction: column;
    }
    
    .stats {
        flex-direction: column;
        gap: 1rem;
    }
    
    th, td {
        padding: 0.8rem 0.5rem;
    }
}
</style>
</head>
<body>

<header class="header">
    <h1>ğŸ“¦ Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ (Firebase)</h1>
    <p>Ù…Ø³Ø­ Ø¶ÙˆØ¦ÙŠ ÙˆØªØ®Ø²ÙŠÙ† ÙˆØ¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ QR Ùˆ Barcode</p>
</header>

<div class="container">

    <!-- Create Archive -->
    <div class="card">
        <h2 class="card-title">â• Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ Ø¬Ø¯ÙŠØ¯</h2>
        <div class="input-group">
            <input id="newArchive" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯" autocomplete="off">
        </div>
        <button id="addArchiveBtn" class="btn">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
    </div>

    <!-- Select Archive -->
    <div class="card">
        <h2 class="card-title">ğŸ—‚ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù†Ø´Ø·</h2>
        <div class="input-group">
            <select id="archiveSelect">
                <option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ</option>
            </select>
        </div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value" id="archiveCount">0</div>
                <div class="stat-label">Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="codeCount">0</div>
                <div class="stat-label">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="lastScan">-</div>
                <div class="stat-label">Ø¢Ø®Ø± Ù…Ø³Ø­</div>
            </div>
        </div>
    </div>

    <!-- Scanner -->
    <div class="card">
        <h2 class="card-title">ğŸ“· Ø§Ù„Ù…Ø§Ø³Ø­ Ø§Ù„Ø¶ÙˆØ¦ÙŠ</h2>
        <div class="controls">
            <button id="startCam" class="btn pulse">ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
            <button class="btn btn-stop" id="stopCam">Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
        </div>
        <div id="scanner"></div>
        <div class="scanner-info">
            <p>ÙŠØªÙ… Ø­ÙØ¸ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ù…Ø³Ø­. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹.</p>
        </div>
    </div>

    <!-- Search -->
    <div class="card">
        <h2 class="card-title">ğŸ” Ø¨Ø­Ø« Ø³Ø±ÙŠØ¹</h2>
        <div class="input-group">
            <input id="searchInput" inputmode="numeric" maxlength="6" placeholder="Ø£Ø¯Ø®Ù„ 6 Ø£Ø±Ù‚Ø§Ù… Ù„Ù„Ø¨Ø­Ø« (Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„)">
        </div>
        <div id="searchResult" class="search-result"></div>
    </div>

    <!-- Codes List -->
    <div class="card">
        <h2 class="card-title">ğŸ“„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø®Ø²Ù†Ø©</h2>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th width="70%">Ø§Ù„ÙƒÙˆØ¯</th>
                        <th width="30%">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="list">
                    <tr>
                        <td colspan="2" class="loading">Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <div class="controls" style="margin-top: 1rem;">
            <button class="btn btn-secondary" id="exportBtn">ØªØµØ¯ÙŠØ± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</button>
            <button class="btn btn-stop" id="clearBtn">Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯</button>
        </div>
    </div>

</div>

<footer class="footer">
    <p>ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Firebase | Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ &copy; 2023</p>
</footer>

<audio id="beep" preload="auto">
    <source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.mp3">
</audio>

<!-- ğŸ”¥ Firebase ES Module -->
<script type="module">
/* ================= FIREBASE IMPORTS ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
import {
  getFirestore, collection, doc, getDoc, getDocs,
  setDoc, updateDoc, deleteDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ================= FIREBASE CONFIG ================= */
const firebaseConfig = {
  apiKey: "AIzaSyCGCX07TI3q2nCCPj_x7t_qZH7WJaiIOOI",
  authDomain: "fatoraqr.firebaseapp.com",
  projectId: "fatoraqr",
  storageBucket: "fatoraqr.firebasestorage.app",
  messagingSenderId: "421490248396",
  appId: "1:421490248396:web:4ac9f162587fe97fb5d069",
  measurementId: "G-QK8C1F6K4S"
};

/* ================= INIT ================= */
const app = initializeApp(firebaseConfig);
getAnalytics(app);
const db = getFirestore(app);

/* ================= ELEMENTS ================= */
const select = document.getElementById("archiveSelect");
const list = document.getElementById("list");
const searchInput = document.getElementById("searchInput");
const searchResult = document.getElementById("searchResult");
const beep = document.getElementById("beep");
const archiveCount = document.getElementById("archiveCount");
const codeCount = document.getElementById("codeCount");
const lastScan = document.getElementById("lastScan");

/* ================= LOAD ARCHIVES ================= */
async function loadArchives() {
    select.innerHTML = '<option value="" disabled selected>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</option>';
    try {
        const snap = await getDocs(collection(db, "archives"));
        select.innerHTML = '<option value="" disabled selected>Ø§Ø®ØªØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ</option>';
        
        let count = 0;
        snap.forEach(d => {
            const o = document.createElement("option");
            o.value = d.id;
            o.textContent = d.id;
            select.appendChild(o);
            count++;
        });
        
        archiveCount.textContent = count;
        
        if (select.value) loadCodes();
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙØ§Øª:", error);
        select.innerHTML = '<option value="" disabled selected>Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</option>';
    }
}

/* ================= LOAD CODES ================= */
async function loadCodes() {
    list.innerHTML = '<tr><td colspan="2" class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</td></tr>';
    
    if (!select.value) {
        list.innerHTML = '<tr><td colspan="2" class="loading">Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹</td></tr>';
        codeCount.textContent = "0";
        return;
    }
    
    try {
        const ref = doc(db, "archives", select.value);
        const snap = await getDoc(ref);
        
        if (!snap.exists()) {
            list.innerHTML = '<tr><td colspan="2" class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</td></tr>';
            codeCount.textContent = "0";
            return;
        }
        
        const codes = snap.data().codes || [];
        codeCount.textContent = codes.length;
        
        if (codes.length === 0) {
            list.innerHTML = '<tr><td colspan="2" class="loading">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</td></tr>';
            return;
        }
        
        list.innerHTML = "";
        codes.forEach((c, i) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td dir="ltr">${c}</td>
                <td><button class="btn-del" onclick="deleteCode(${i})">Ø­Ø°Ù</button></td>
            `;
            list.appendChild(tr);
        });
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯:", error);
        list.innerHTML = '<tr><td colspan="2" class="loading">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„</td></tr>';
    }
}

/* ================= ADD ARCHIVE ================= */
document.getElementById("addArchiveBtn").onclick = async () => {
    const name = document.getElementById("newArchive").value.trim();
    if (!name) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ");
        return;
    }
    
    try {
        await setDoc(doc(db, "archives", name), { codes: [], createdAt: new Date().toISOString() });
        document.getElementById("newArchive").value = "";
        await loadArchives();
        select.value = name;
        loadCodes();
        
        // Show success message
        searchResult.innerHTML = `<div class="result-found">âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙŠÙ "${name}" Ø¨Ù†Ø¬Ø§Ø­</div>`;
        setTimeout(() => {
            if (searchInput.value.length < 6) searchResult.innerHTML = "";
        }, 3000);
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙŠÙ:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø±Ø´ÙŠÙ");
    }
};

select.onchange = loadCodes;

/* ================= DELETE CODE ================= */
window.deleteCode = async (i) => {
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ØŸ")) return;
    
    try {
        const ref = doc(db, "archives", select.value);
        const snap = await getDoc(ref);
        const arr = snap.data().codes;
        arr.splice(i, 1);
        await updateDoc(ref, { codes: arr });
        loadCodes();
        
        // Show success message
        searchResult.innerHTML = `<div class="result-found">âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­</div>`;
        setTimeout(() => {
            if (searchInput.value.length < 6) searchResult.innerHTML = "";
        }, 3000);
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯");
    }
};

/* ================= CLEAR ALL CODES ================= */
document.getElementById("clearBtn").onclick = async () => {
    if (!select.value) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }
    
    if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.")) return;
    
    try {
        const ref = doc(db, "archives", select.value);
        await updateDoc(ref, { codes: [] });
        loadCodes();
        
        // Show success message
        searchResult.innerHTML = `<div class="result-found">âœ… ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¨Ù†Ø¬Ø§Ø­</div>`;
        setTimeout(() => {
            if (searchInput.value.length < 6) searchResult.innerHTML = "";
        }, 3000);
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
    }
};

/* ================= EXPORT CODES ================= */
document.getElementById("exportBtn").onclick = async () => {
    if (!select.value) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }
    
    try {
        const ref = doc(db, "archives", select.value);
        const snap = await getDoc(ref);
        
        if (!snap.exists() || !snap.data().codes || snap.data().codes.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙƒÙˆØ§Ø¯ Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§");
            return;
        }
        
        const codes = snap.data().codes;
        const content = codes.join("\n");
        const blob = new Blob([content], { type: "text/plain" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${select.value}_codes_${new Date().toISOString().slice(0,10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        // Show success message
        searchResult.innerHTML = `<div class="result-found">âœ… ØªÙ… ØªØµØ¯ÙŠØ± ${codes.length} ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­</div>`;
        setTimeout(() => {
            if (searchInput.value.length < 6) searchResult.innerHTML = "";
        }, 3000);
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØµØ¯ÙŠØ± Ø§Ù„Ø£ÙƒÙˆØ§Ø¯");
    }
};

/* ================= SEARCH ================= */
searchInput.oninput = async () => {
    searchInput.value = searchInput.value.replace(/\D/g, "").slice(0, 6);
    
    if (searchInput.value.length < 6) {
        searchResult.innerHTML = "";
        return;
    }

    try {
        const snap = await getDocs(collection(db, "archives"));
        let found = [];
        snap.forEach(d => {
            if (d.data().codes && d.data().codes.includes(searchInput.value)) {
                found.push(d.id);
            }
        });
        
        if (found.length > 0) {
            searchResult.innerHTML = `<div class="result-found">âœ… Ø§Ù„ÙƒÙˆØ¯ ${searchInput.value} Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ: ${found.join(" , ")}</div>`;
        } else {
            searchResult.innerHTML = `<div class="result-not-found">âŒ Ø§Ù„ÙƒÙˆØ¯ ${searchInput.value} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø£ÙŠ Ø£Ø±Ø´ÙŠÙ</div>`;
        }
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«:", error);
        searchResult.innerHTML = `<div class="result-not-found">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«</div>`;
    }
};

/* ================= CAMERA ================= */
let qr = null, running = false, lastCode = "", lastScanTime = 0;

document.getElementById("startCam").onclick = async () => {
    if (running) return;
    
    if (!select.value) {
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }
    
    try {
        qr = new Html5Qrcode("scanner");
        document.getElementById("scanner").style.display = "block";
        const cams = await Html5Qrcode.getCameras();
        
        if (cams.length === 0) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒØ§Ù…ÙŠØ±Ø§ Ù…ØªØ§Ø­Ø©");
            return;
        }
        
        // Try to find back camera, otherwise use first available
        const backCam = cams.find(c => c.label.toLowerCase().includes("back"));
        const cam = backCam || cams[0];

        await qr.start(cam.id, { fps: 15, qrbox: 250 }, async txt => {
            const now = Date.now();
            
            // Prevent duplicate scans within 1.5 seconds
            if (txt === lastCode && now - lastScanTime < 1500) return;
            
            lastCode = txt;
            lastScanTime = now;
            
            try {
                const ref = doc(db, "archives", select.value);
                const snap = await getDoc(ref);
                const arr = snap.data().codes || [];
                
                if (!arr.includes(txt)) {
                    arr.push(txt);
                    await updateDoc(ref, { codes: arr });
                    
                    // Update last scan time
                    const timeStr = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
                    lastScan.textContent = timeStr;
                    
                    // Play sound and reload
                    beep.currentTime = 0;
                    beep.play().catch(e => console.log("Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ´ØºÙŠÙ„ Ø§Ù„ØµÙˆØª:", e));
                    
                    loadCodes();
                    
                    // Show success message
                    searchResult.innerHTML = `<div class="result-found">âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯: ${txt}</div>`;
                    setTimeout(() => {
                        if (searchInput.value.length < 6) searchResult.innerHTML = "";
                    }, 2000);
                } else {
                    searchResult.innerHTML = `<div class="result-not-found">âš ï¸ Ø§Ù„ÙƒÙˆØ¯ ${txt} Ù…ÙˆØ¬ÙˆØ¯ Ù…Ø³Ø¨Ù‚Ø§Ù‹</div>`;
                    setTimeout(() => {
                        if (searchInput.value.length < 6) searchResult.innerHTML = "";
                    }, 2000);
                }
            } catch (error) {
                console.error("Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯:", error);
                searchResult.innerHTML = `<div class="result-not-found">âŒ Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„ÙƒÙˆØ¯</div>`;
            }
        });
        
        running = true;
        document.getElementById("startCam").textContent = "Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø´ØºØ§Ù„Ø©";
        document.getElementById("startCam").classList.remove("pulse");
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
    }
};

document.getElementById("stopCam").onclick = async () => {
    if (!running) return;
    
    try {
        await qr.stop();
        qr.clear();
        document.getElementById("scanner").style.display = "none";
        running = false;
        document.getElementById("startCam").textContent = "ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§";
        document.getElementById("startCam").classList.add("pulse");
    } catch (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§:", error);
    }
};

/* ================= INITIALIZE ================= */
loadArchives();

// Set initial time
const timeStr = new Date().toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
lastScan.textContent = timeStr;

// Enter key to create archive
document.getElementById("newArchive").addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        document.getElementById("addArchiveBtn").click();
    }
});

// Enter key to search
searchInput.addEventListener("keypress", (e) => {
    if (e.key === "Enter") {
        searchInput.oninput();
    }
});
</script>

</body>
</html>
