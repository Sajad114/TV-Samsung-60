<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@400;600;700&display=swap');

*{box-sizing:border-box}

body{
    margin:0;
    font-family:'Tajawal',sans-serif;
    background:linear-gradient(135deg,#050505,#111);
    color:#fff;
}

header{
    text-align:center;
    padding:15px;
    font-size:22px;
    font-weight:700;
    background:rgba(255,255,255,.04);
    border-bottom:1px solid rgba(255,255,255,.1);
}

.container{
    max-width:900px;
    margin:auto;
    padding:15px;
}

.card{
    background:rgba(255,255,255,.06);
    backdrop-filter:blur(14px);
    border-radius:16px;
    padding:15px;
    margin-bottom:15px;
    box-shadow:0 15px 40px rgba(0,0,0,.4);
}

.card h2{
    margin:0 0 10px;
    font-size:16px;
    color:#00ff99;
}

input,select,button{
    width:100%;
    padding:11px;
    border:none;
    border-radius:10px;
    font-size:15px;
    margin-top:6px;
}

input,select{
    background:#111;
    color:#fff;
}

button{
    background:linear-gradient(135deg,#00ff99,#00cc88);
    color:#000;
    font-weight:700;
    cursor:pointer;
}

button.stop{
    background:#ff4444;
    color:#fff;
}

button.del{
    background:#ff4444;
    color:#fff;
}

#scanner{
    width:100%;
    max-width:320px;
    margin:auto;
    border-radius:14px;
    overflow:hidden;
    box-shadow:0 0 25px rgba(0,255,153,.4);
    display:none;
}

.controls{
    display:flex;
    gap:10px;
}

table{
    width:100%;
    border-collapse:collapse;
    margin-top:10px;
}

th,td{
    padding:10px;
    border-bottom:1px solid rgba(255,255,255,.1);
    text-align:center;
}

th{color:#00ff99}

.search-result{
    margin-top:8px;
    padding:10px;
    border-radius:10px;
    background:#111;
}
</style>
</head>
<body>

<header>ğŸ“¦ Ù†Ø¸Ø§Ù… Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</header>

<div class="container">

<!-- Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ -->
<div class="card">
<h2>â• Ø¥Ù†Ø´Ø§Ø¡ Ø£Ø±Ø´ÙŠÙ Ø¬Ø¯ÙŠØ¯</h2>
<input id="newArchive" placeholder="Ø§Ø³Ù… Ø§Ù„Ø£Ø±Ø´ÙŠÙ">
<button onclick="addArchive()">Ø¥Ù†Ø´Ø§Ø¡</button>
</div>

<!-- Ø§Ø®ØªÙŠØ§Ø± Ø£Ø±Ø´ÙŠÙ -->
<div class="card">
<h2>ğŸ—‚ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h2>
<select id="archiveSelect"></select>
</div>

<!-- Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ -->
<div class="card">
<h2>ğŸ“· Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</h2>

<div class="controls">
<button onclick="startCamera()">â–¶ï¸ ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
<button class="stop" onclick="stopCamera()">â¹ Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
</div>

<div id="scanner"></div>
</div>

<!-- Ø§Ù„Ø¨Ø­Ø« -->
<div class="card">
<h2>ğŸ” Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„</h2>
<input id="searchInput" placeholder="Ø§ÙƒØªØ¨ Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„">
<div id="searchResult" class="search-result"></div>
</div>

<!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ -->
<div class="card">
<h2>ğŸ“„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</h2>
<table>
<thead>
<tr>
<th>Ø§Ù„ÙƒÙˆØ¯</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

</div>

<!-- ğŸ”Š ØµÙˆØª Ø§Ø­ØªØ±Ø§ÙÙŠ -->
<audio id="beep" preload="auto">
<source src="https://assets.mixkit.co/sfx/preview/mixkit-classic-click-1117.mp3">
</audio>

<script>
/* ================= DATA ================= */
const STORAGE="BARCODE_ARCHIVES_V5";
let archives=JSON.parse(localStorage.getItem(STORAGE))||{A1:[]};

/* ================= ELEMENTS ================= */
const select=document.getElementById("archiveSelect");
const list=document.getElementById("list");
const beep=document.getElementById("beep");
const searchInput=document.getElementById("searchInput");
const searchResult=document.getElementById("searchResult");
const scannerBox=document.getElementById("scanner");

/* ================= SCAN CONTROL ================= */
let lastScan="";
let lastTime=0;
const COOLDOWN=1500;
let qr=null;
let cameraRunning=false;

/* ================= STORAGE ================= */
function save(){
    localStorage.setItem(STORAGE,JSON.stringify(archives));
}

/* ================= RENDER ================= */
function renderArchives(){
    select.innerHTML="";
    Object.keys(archives).forEach(a=>{
        const o=document.createElement("option");
        o.value=a;
        o.textContent=`${a} (${archives[a].length})`;
        select.appendChild(o);
    });
    renderCodes();
}

function renderCodes(){
    list.innerHTML="";
    archives[select.value].forEach((c,i)=>{
        list.innerHTML+=`
        <tr>
            <td>${c}</td>
            <td><button class="del" onclick="deleteCode(${i})">Ø­Ø°Ù</button></td>
        </tr>`;
    });
}

/* ================= ARCHIVE ================= */
function addArchive(){
    const n=document.getElementById("newArchive").value.trim();
    if(!n||archives[n]) return alert("Ø§Ø³Ù… ØºÙŠØ± ØµØ§Ù„Ø­");
    archives[n]=[];
    save();
    document.getElementById("newArchive").value="";
    renderArchives();
}

/* ================= DELETE ================= */
function deleteCode(i){
    if(!confirm("ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ø§Ù„ÙˆØµÙ„ØŸ")) return;
    archives[select.value].splice(i,1);
    save();
    renderCodes();
}

select.onchange=renderCodes;

/* ================= SEARCH ================= */
let timer=null;
searchInput.oninput=()=>{
    clearTimeout(timer);
    timer=setTimeout(()=>{
        const v=searchInput.value.trim();
        if(!v){searchResult.innerHTML="";return;}
        let found=[];
        for(let a in archives){
            if(archives[a].includes(v)) found.push(a);
        }
        searchResult.innerHTML=found.length
        ? `âœ… Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: <b>${found.join(" , ")}</b>`
        : "âŒ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯";
    },200);
};

/* ================= CAMERA ================= */
async function startCamera(){
    if(cameraRunning) return;
    scannerBox.style.display="block";
    qr=new Html5Qrcode("scanner");

    const cams=await Html5Qrcode.getCameras();
    let cam=cams.find(c=>c.label.toLowerCase().includes("back"))||cams[0];

    await qr.start(
        cam.id,
        {fps:15,qrbox:230},
        async txt=>{
            const now=Date.now();
            if(txt===lastScan && now-lastTime<COOLDOWN) return;
            lastScan=txt; lastTime=now;

            const arch=select.value;
            if(!archives[arch].includes(txt)){
                archives[arch].push(txt);
                beep.currentTime=0;
                beep.play();
                save();
                renderCodes();
                await qr.pause();
                setTimeout(()=>qr.resume(),400);
            }
        }
    );
    cameraRunning=true;
}

async function stopCamera(){
    if(!cameraRunning) return;
    await qr.stop();
    qr.clear();
    scannerBox.style.display="none";
    cameraRunning=false;
}

/* ================= INIT ================= */
renderArchives();
</script>

</body>
</html>
